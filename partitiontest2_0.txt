val yes = spark.sql("select * from df_tpc_ds.customer where c_preferred_cust_flag  = 'Y'")
yes: org.apache.spark.sql.DataFrame = [ziw_row_id: string, ziw_scn: decimal(38,18) ... 29 more fields]

val no = spark.sql("select * from df_tpc_ds.customer where c_preferred_cust_flag  = 'N'")

scala> yes.count()
res0: Long = 23

scala> no.count()
res1: Long = 27


yes.write.format("orc").partitionBy("c_preferred_cust_flag").saveAsTable("cpar")

17/11/05 06:34:40 WARN CreateDataSourceTableUtils: Persisting partitioned data source relation `cpar` into Hive metastore in Spark SQL specific format, which is NOT compatible with Hive. Input path(s):
hdfs://ip-172-30-1-247.ec2.internal:8020/apps/hive/warehouse/cpar

no.write.format("orc").partitionBy("c_preferred_cust_flag").saveAsTable("cpar2")

17/11/05 06:34:53 WARN CreateDataSourceTableUtils: Persisting partitioned data source relation `cpar2` into Hive metastore in Spark SQL specific format, which is NOT compatible with Hive. Input path(s):
hdfs://ip-172-30-1-247.ec2.internal:8020/apps/hive/warehouse/cpar2

0: jdbc:hive2://localhost:10000/default> drop table cpar;
No rows affected (0.209 seconds)
0: jdbc:hive2://localhost:10000/default> drop table cpar2;
No rows affected (0.209 seconds)
0: jdbc:hive2://localhost:10000/default> show create table cpar;

| CREATE TABLE `cpar`(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|   `col` array<string> COMMENT 'from deserializer')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ROW FORMAT SERDE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|   'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| WITH SERDEPROPERTIES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   'path'='hdfs://ip-172-30-1-247.ec2.internal:8020/apps/hive/warehouse/cpar')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| STORED AS INPUTFORMAT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|   'org.apache.hadoop.mapred.SequenceFileInputFormat'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| OUTPUTFORMAT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|   'org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| LOCATION                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|   'hdfs://ip-172-30-1-247.ec2.internal:8020/apps/hive/warehouse/cpar'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| TBLPROPERTIES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|   'EXTERNAL'='FALSE',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|   'numFiles'='1',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   'spark.sql.sources.provider'='orc',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|   'spark.sql.sources.schema.numPartCols'='1',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|   'spark.sql.sources.schema.numParts'='1',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|   'spark.sql.sources.schema.part.0'='{\"type\":\"struct\",\"fields\":[{\"name\":\"ziw_row_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_scn\",\"type\":\"decimal(38,18)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_source_start_date\",\"type\":\"date\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_source_start_timestamp\",\"type\":\"timestamp\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_target_start_timestamp\",\"type\":\"timestamp\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_target_start_date\",\"type\":\"date\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_source_end_date\",\"type\":\"date\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_source_end_timestamp\",\"type\":\"timestamp\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_target_end_date\",\"type\":\"date\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_target_end_timestamp\",\"type\":\"timestamp\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_active\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_is_deleted\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_status_flag\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_customer_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_customer_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_current_cdemo_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_current_hdemo_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_current_addr_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_first_shipto_date_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_first_sales_date_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_salutation\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_first_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_last_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_birth_day\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_birth_month\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_birth_year\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_birth_country\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_login\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_email_address\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_last_review_date\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_preferred_cust_flag\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}}]}',   |
|   'spark.sql.sources.schema.partCol.0'='c_preferred_cust_flag',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|   'totalSize'='7142',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|   'transient_lastDdlTime'='1509863680')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+
22 rows selected (0.107 seconds)
0: jdbc:hive2://localhost:10000/default>

:52:59 2017 from 106.200.223.100
[ec2-user@dev2 ~]$ hdfs dfs -ls /apps/hive/warehouse/cpar
Found 2 items
-rw-r--r--   3 ec2-user hdfs          0 2017-11-05 04:56 /apps/hive/warehouse/cpar/_SUCCESS
drwxr-xr-x   - ec2-user hdfs          0 2017-11-05 04:56 /apps/hive/warehouse/cpar/c_preferred_cust_flag=Y
[ec2-user@dev2 ~]$ hdfs dfs -ls /apps/hive/warehouse/cpar2
Found 2 items
-rw-r--r--   3 ec2-user hdfs          0 2017-11-05 04:57 /apps/hive/warehouse/cpar2/_SUCCESS
drwxr-xr-x   - ec2-user hdfs          0 2017-11-05 04:57 /apps/hive/warehouse/cpar2/c_preferred_cust_flag=N
[ec2-user@dev2 ~]$

// copy over cpar2 to cpar

[ec2-user@dev2 cpar2]$ hdfs dfs -ls /apps/hive/warehouse/cpar
Found 3 items
-rw-r--r--   3 ec2-user hdfs          0 2017-11-05 04:56 /apps/hive/warehouse/cpar/_SUCCESS
drwxr-xr-x   - ec2-user hdfs          0 2017-11-05 05:01 /apps/hive/warehouse/cpar/c_preferred_cust_flag=N
drwxr-xr-x   - ec2-user hdfs          0 2017-11-05 04:56 /apps/hive/warehouse/cpar/c_preferred_cust_flag=Y

 val full = spark.sql("select * from cpar");
full: org.apache.spark.sql.DataFrame = [ziw_row_id: string, ziw_scn: decimal(38,18) ... 29 more fields]

 val full = spark.sql("select * from cpar");
full: org.apache.spark.sql.DataFrame = [ziw_row_id: string, ziw_scn: decimal(38,18) ... 29 more fields]

scala> full.count()
res5: Long = 50


spark.sql("alter table cpar add partition(c_preferred_cust_flag='N')")
res6: org.apache.spark.sql.DataFrame = []

spark.sql("alter table cpar add partition(c_preferred_cust_flag='N')")
org.apache.spark.sql.AnalysisException: ALTER TABLE ADD PARTITION is not allowed for tables defined using the datasource API;
  at org.apache.spark.sql.execution.command.AlterTableAddPartitionCommand.run(ddl.scala:353)
  at org.apache.spark.sql.execution.command.ExecutedCommandExec.sideEffectResult$lzycompute(commands.scala:58)
  at org.apache.spark.sql.execution.command.ExecutedCommandExec.sideEffectResult(commands.scala:56)
  at org.apache.spark.sql.execution.command.ExecutedCommandExec.doExecute(commands.scala:74)
  at org.apache.spark.sql.execution.SparkPlan$$anonfun$execute$1.apply(SparkPlan.scala:115)
  at org.apache.spark.sql.execution.SparkPlan$$anonfun$execute$1.apply(SparkPlan.scala:115)
  at org.apache.spark.sql.execution.SparkPlan$$anonfun$executeQuery$1.apply(SparkPlan.scala:136)
  at org.apache.spark.rdd.RDDOperationScope$.withScope(RDDOperationScope.scala:151)
  at org.apache.spark.sql.execution.SparkPlan.executeQuery(SparkPlan.scala:133)
  at org.apache.spark.sql.execution.SparkPlan.execute(SparkPlan.scala:114)
  at org.apache.spark.sql.execution.QueryExecution.toRdd$lzycompute

scala> full.count()
res7: Long = 50
 
 
 0: jdbc:hive2://localhost:10000/default>  show create table cpar;
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              createtab_stmt                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+
| CREATE TABLE `cpar`(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|   `col` array<string> COMMENT 'from deserializer')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ROW FORMAT SERDE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|   'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| WITH SERDEPROPERTIES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|   'path'='hdfs://ip-172-30-1-247.ec2.internal:8020/apps/hive/warehouse/cpar')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| STORED AS INPUTFORMAT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|   'org.apache.hadoop.mapred.SequenceFileInputFormat'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| OUTPUTFORMAT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|   'org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| LOCATION                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|   'hdfs://ip-172-30-1-247.ec2.internal:8020/apps/hive/warehouse/cpar'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| TBLPROPERTIES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|   'EXTERNAL'='FALSE',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|   'numFiles'='1',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|   'spark.sql.sources.provider'='orc',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|   'spark.sql.sources.schema.numPartCols'='1',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|   'spark.sql.sources.schema.numParts'='1',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|   'spark.sql.sources.schema.part.0'='{\"type\":\"struct\",\"fields\":[{\"name\":\"ziw_row_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_scn\",\"type\":\"decimal(38,18)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_source_start_date\",\"type\":\"date\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_source_start_timestamp\",\"type\":\"timestamp\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_target_start_timestamp\",\"type\":\"timestamp\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_target_start_date\",\"type\":\"date\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_source_end_date\",\"type\":\"date\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_source_end_timestamp\",\"type\":\"timestamp\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_target_end_date\",\"type\":\"date\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_target_end_timestamp\",\"type\":\"timestamp\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_active\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_is_deleted\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ziw_status_flag\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_customer_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_customer_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_current_cdemo_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_current_hdemo_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_current_addr_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_first_shipto_date_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_first_sales_date_sk\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_salutation\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_first_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_last_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_birth_day\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_birth_month\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_birth_year\",\"type\":\"decimal(38,0)\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_birth_country\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_login\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_email_address\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_last_review_date\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"c_preferred_cust_flag\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}}]}',   |
|   'spark.sql.sources.schema.partCol.0'='c_preferred_cust_flag',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|   'totalSize'='7142',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|   'transient_lastDdlTime'='1509863680')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+
22 rows selected (0.077 seconds)
0: jdbc:hive2://localhost:10000/default>
dint change the metadata
0: jdbc:hive2://localhost:10000/default>

scala> val full = spark.sql("select * from cpar");
full: org.apache.spark.sql.DataFrame = [ziw_row_id: string, ziw_scn: decimal(38,18) ... 29 more fields]

full.count();
17/11/05 06:42:24 WARN Utils: Truncated the string representation of a plan since it was too large. This behavior can be adjusted by setting 'spark.debug.maxToStringFields' in SparkEnv.conf.
res0: Long = 50 --- triggers a job


scala> full.filter("c_preferred_cust_flag='N'").count()
res9: Long = 27


scala> full.filter("c_preferred_cust_flag='R'").count()
res11: Long = 0


restart spark 
================

Using Scala version 2.11.8 (OpenJDK 64-Bit Server VM, Java 1.8.0_131)
Type in expressions to have them evaluated.
Type :help for more information.

scala>  val full = spark.sql("select * from cpar");
full: org.apache.spark.sql.DataFrame = [ziw_row_id: string, ziw_scn: decimal(38,18) ... 29 more fields]

scala> full.count()
17/11/05 05:25:01 WARN Utils: Truncated the string representation of a plan since it was too large. This behavior can be adjusted by setting 'spark.debug.maxToStringFields' in SparkEnv.conf.
res0: Long = 50

scala> full.filter("c_preferred_cust_flag='R'").count()
res1: Long = 0
scala> full.filter("c_preferred_cust_flag=''").count()
res2: Long = 0

scala> full.filter("c_preferred_cust_flag='N'").count()
res3: Long = 27


scala> full.filter("c_preferred_cust_flag='Y'").count()
res5: Long = 23



=========================================================================================================================

hive compatible tests  ( via create  table command)


spark.sql("create table hivecustpar (ziw_row_id string ,c_customer_sk decimal(38,0) ,c_customer_id string ) PARTITIONED BY (c_preferred_cust_flag string)    stored as orc    LOCATION '/iw/testmm/output/hivecustpar' ")


spark.sql("set hive.exec.dynamic.partition=true")
spark.sql("set hive.exec.dynamic.partition.mode=nonstrict")
hive.exec.dynamic.partition.mode=nonstrict
scala> val yes = spark.sql("select ziw_row_id,c_customer_sk,c_customer_id,c_preferred_cust_flag from df_tpc_ds.customer where c_preferred_cust_flag  = 'Y'")
yes: org.apache.spark.sql.DataFrame = [ziw_row_id: string, ziw_scn: decimal(38,18) ... 29 more fields]

scala> yes.count()
res2: Long = 23



 yes.write.format("orc").insertInto("hivecustpar")
17/11/06 08:24:38 ERROR KeyProviderCache: Could not find uri with key [dfs.encryption.key.provider.uri] to create a keyProvider !!


spark.sql("create table hivecustparno (ziw_row_id string ,c_customer_sk decimal(38,0) ,c_customer_id string ) PARTITIONED BY (c_preferred_cust_flag string)  stored as orc      LOCATION '/iw/testmm/output/hivecustparno' ")

res19: org.apache.spark.sql.DataFrame = []

hive
1 row selected (3.919 seconds)
0: jdbc:hive2://localhost:10000/default> show create table hivecustpar;
+----------------------------------------------------------------------------+--+
|                               createtab_stmt                               |
+----------------------------------------------------------------------------+--+
| CREATE EXTERNAL TABLE `hivecustpar`(                                       |
|   `ziw_row_id` string,                                                     |
|   `c_customer_sk` decimal(38,0),                                           |
|   `c_customer_id` string)                                                  |
| PARTITIONED BY (                                                           |
|   `c_preferred_cust_flag` string)                                          |
| ROW FORMAT SERDE                                                           |
|   'org.apache.hadoop.hive.ql.io.orc.OrcSerde'                              |
| STORED AS INPUTFORMAT                                                      |
|   'org.apache.hadoop.hive.ql.io.orc.OrcInputFormat'                        |
| OUTPUTFORMAT                                                               |
|   'org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat'                       |
| LOCATION                                                                   |
|   'hdfs://ip-172-30-1-247.ec2.internal:8020/iw/testmm/output/hivecustpar'  |
| TBLPROPERTIES (                                                            |
|   'transient_lastDdlTime'='1509956578')                                    |
+----------------------------------------------------------------------------+--+
 val no = spark.sql("select ziw_row_id,c_customer_sk,c_customer_id,c_preferred_cust_flag from df_tpc_ds.customer where c_preferred_cust_flag  = 'N'")
 no.write.format("orc").insertInto("hivecustparno")


 hdfs dfs -ls /iw/testmm/output/hivecustpar
Found 2 items
drwxr-xr-x   - ec2-user hdfs          0 2017-11-06 08:24 /iw/testmm/output/hivecustpar/.hive-staging_hive_2017-11-06_08-24-37_750_5487880111172121859-1
drwxr-xr-x   - ec2-user hdfs          0 2017-11-06 08:24 /iw/testmm/output/hivecustpar/c_preferred_cust_flag=Y
[ec2-user@dev2 ~]$ hdfs dfs -ls /iw/testmm/output/hivecustparno
Found 2 items
drwxr-xr-x   - ec2-user hdfs          0 2017-11-06 08:25 /iw/testmm/output/hivecustparno/.hive-staging_hive_2017-11-06_08-25-22_167_2095748922805826378-1
drwxr-xr-x   - ec2-user hdfs          0 2017-11-06 08:25 /iw/testmm/output/hivecustparno/c_preferred_cust_flag=N

o rows affected (0.397 seconds)
0: jdbc:hive2://localhost:10000/default> select count(*) from hivecustpar;
INFO  : Session is already open
INFO  : Dag name: select count(*) from hivecustpar(Stage-1)
INFO  :

INFO  : Status: Running (Executing on YARN cluster with App id application_1509712684194_0103)

INFO  : Map 1: 0/1	Reducer 2: 0/1
INFO  : Map 1: 0(+1)/1	Reducer 2: 0/1
INFO  : Map 1: 1/1	Reducer 2: 0(+1)/1
INFO  : Map 1: 1/1	Reducer 2: 1/1
+------+--+
| _c0  |
+------+--+
| 23   |
+------+--+


///copy files over
 hdfs dfs -ls /iw/testmm/output/hivecustpar/
Found 3 items
drwxr-xr-x   - ec2-user hdfs          0 2017-11-06 08:24 /iw/testmm/output/hivecustpar/.hive-staging_hive_2017-11-06_08-24-37_750_5487880111172121859-1
drwxr-xr-x   - ec2-user hdfs          0 2017-11-06 08:27 /iw/testmm/output/hivecustpar/c_preferred_cust_flag=N
drwxr-xr-x   - ec2-user hdfs          0 2017-11-06 08:24 /iw/testmm/output/hivecustpar/c_preferred_cust_flag=Y
[ec2-user@dev2 hivecustparno]$

 val full = spark.sql("select * from hivecustpar");
full: org.apache.spark.sql.DataFrame = [ziw_row_id: string, c_customer_sk: decimal(38,0) ... 2 more fields]

scala> full.count()
res22: Long = 23
 select count(*) from hivecustpar;
INFO  : Session is already open
INFO  : Dag name: select count(*) from hivecustpar(Stage-1)
INFO  :

INFO  : Status: Running (Executing on YARN cluster with App id application_1509712684194_0103)

INFO  : Map 1: 0/1	Reducer 2: 0/1
INFO  : Map 1: 0(+1)/1	Reducer 2: 0/1
INFO  : Map 1: 1/1	Reducer 2: 0(+1)/1
INFO  : Map 1: 1/1	Reducer 2: 1/1
+------+--+
| _c0  |
+------+--+
| 23   |
+------+--+


spark.sql("ALTER TABLE hivecustpar  add partition(c_preferred_cust_flag='N')")
res23: org.apache.spark.sql.DataFrame = []

show create table hivecustpar;
+----------------------------------------------------------------------------+--+
|                               createtab_stmt                               |
+----------------------------------------------------------------------------+--+
| CREATE EXTERNAL TABLE `hivecustpar`(                                       |
|   `ziw_row_id` string,                                                     |
|   `c_customer_sk` decimal(38,0),                                           |
|   `c_customer_id` string)                                                  |
| PARTITIONED BY (                                                           |
|   `c_preferred_cust_flag` string)                                          |
| ROW FORMAT SERDE                                                           |
|   'org.apache.hadoop.hive.ql.io.orc.OrcSerde'                              |
| STORED AS INPUTFORMAT                                                      |
|   'org.apache.hadoop.hive.ql.io.orc.OrcInputFormat'                        |
| OUTPUTFORMAT                                                               |
|   'org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat'                       |
| LOCATION                                                                   |
|   'hdfs://ip-172-30-1-247.ec2.internal:8020/iw/testmm/output/hivecustpar'  |
| TBLPROPERTIES (                                                            |
|   'transient_lastDdlTime'='1509956578')

jdbc:hive2://localhost:10000/default> show partitions hivecustpar;
+--------------------------+--+
|        partition         |
+--------------------------+--+
| c_preferred_cust_flag=N  |
| c_preferred_cust_flag=Y  |

scala> full.count()
res24: Long = 23

// need to reload full df again since above seems to be cached 
 val full = spark.sql("select * from hivecustpar");
full: org.apache.spark.sql.DataFrame = [ziw_row_id: string, c_customer_sk: decimal(38,0) ... 2 more fields]

scala> full.count()
res11: Long = 50


scala> full.filter("c_preferred_cust_flag='N'").count()
res25: Long = 27

scala> full.filter("c_preferred_cust_flag='R'").count()
res26: Long = 0


select count(*) from hivecustpar;
INFO  : Session is already open
INFO  : Dag name: select count(*) from hivecustpar(Stage-1)
INFO  :

INFO  : Status: Running (Executing on YARN cluster with App id application_1509712684194_0103)

INFO  : Map 1: 0/1	Reducer 2: 0/1
INFO  : Map 1: 0(+1)/1	Reducer 2: 0/1
INFO  : Map 1: 1/1	Reducer 2: 0/1
INFO  : Map 1: 1/1	Reducer 2: 0(+1)/1
INFO  : Map 1: 1/1	Reducer 2: 1/1
+------+--+
| _c0  |
+------+--+
| 50   |
+------+--+
1 row selected (3.925 seconds)